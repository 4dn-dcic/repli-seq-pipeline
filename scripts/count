#!/usr/bin/env bash

usage() {
  echo "Usage: $(basename $0) [-t threads ] -w windows.bed bed1 [bed2 ... bedN ]" 1>&2
  echo "" 1>&2
  exit 1
}

while getopts ":t:w:" opt; do
  case $opt in
  t)
    NTHREADS=$OPTARG
   ;;
  w)
    WINDOWBED=$OPTARG
   ;;
  \?)
   echo "Invalid option: -$OPTARG" >&2
   usage
   ;;
  [?])
   usage
   ;;
  :)
   echo "Option -$OPTARG requires an argument." >&2
   echo "" >&2
   usage
   ;;
  esac
done

if [ -z $NTHREADS ]; then
  NTHREADS=1
fi

shift $((OPTIND-1))

if [[ $# -eq 0 ]] ; then
  echo 'no files given'
  exit 1
fi

if [[ -z $WINDOWBED ]] ; then
  echo 'window bed not provided'
  exit 1
fi

INPUT=$@

count(){
  INPUT=$1
  WINDOWBED=$2
  
  # check if file exists
  if [[ ! -f $INPUT ]]; then echo "file \"$INPUT\" not found"; exit 1; fi
  if [[ ! -f $WINDOWBED ]]; then echo "file \"$WINDOWBED\" not found"; exit 1; fi
  
  # check input is a bed
  if [[ $INPUT != *.bed ]]; then echo "input is not a bed file"; exit 1; fi
  if [[ $WINDOWBED != *.bed ]]; then echo "window file is not a bed file"; exit 1; fi
  
  BASE="$(basename $INPUT | sed 's/\.bed$//g')"
  WBASE="$(basename $WINDOWBED | sed 's/\.bed//g')"
  OUTPUT=${BASE}_${WBASE}.bg
  
  SCALE=$(echo "1000000/$(cat $INPUT | wc -l)" | bc -l)
  
  bedtools intersect -sorted -c -b $INPUT -a $WINDOWBED | \
  awk -v s=$SCALE '{print $1,$2,$3,$4*1000*(s/$3-$2) }' OFS='\t' > $OUTPUT
  
  echo $OUTPUT
}

export -f count

parallel --will-cite -k -j $NTHREADS "count {} $WINDOWBED" ::: $INPUT

}



